# 嵌入式日志分析工具 - Tauri 架构设计文档

## 1. 项目概述

### 1.1 项目名称
**LogView** - 基于 Tauri 的嵌入式日志分析桌面应用

### 1.2 项目目标
为嵌入式开发者提供一个轻量级、高性能的本地日志分析工具，能够：
- 处理非标准格式的嵌入式设备日志
- 自动按重启会话（Boot）切分日志
- 提取和可视化关键指标（内存、CPU 等）
- 提供多级别日志过滤和染色查看
- 打包为独立桌面应用，无需依赖 Python 或浏览器

### 1.3 核心痛点
- 嵌入式日志格式五花八门，缺乏统一标准
- 设备经常重启，需要区分不同 Boot 会话进行对比分析
- 现有工具要么太重（如 Elasticsearch），要么太简单（记事本）
- 需要快速定位内存泄漏、异常错误等关键问题

---

## 2. 技术栈选型

### 2.1 前端技术
| 技术 | 用途 | 理由 |
|------|------|------|
| **React 18** | UI 框架 | 生态成熟，组件丰富，TypeScript 支持好 |
| **TypeScript** | 类型安全 | 减少运行时错误，提升开发体验 |
| **Tailwind CSS** | 样式方案 | 快速构建现代 UI，Dark Mode 原生支持 |
| **Zustand** | 状态管理 | 轻量级，避免 Redux 的繁琐 |
| **Recharts** | 图表库 | 声明式 API，易于定制，适合时间序列数据 |
| **react-window** | 虚拟滚动 | 处理大量日志行时保持流畅 |

### 2.2 后端技术
| 技术 | 用途 | 理由 |
|------|------|------|
| **Rust** | Tauri Backend | 高性能正则匹配，极低内存占用 |
| **regex** | 正则引擎 | Rust 原生正则库，性能优异 |
| **serde** | 序列化 | 前后端数据交换 |
| **tokio** | 异步运行时 | 处理大文件时避免阻塞 UI |

### 2.3 开发工具
- **Vite**: 前端构建工具（Tauri 官方推荐）
- **Rust 1.70+**: 后端编译
- **pnpm**: 包管理器（比 npm 快）

---

## 3. 系统架构

### 3.1 分层架构
```
┌─────────────────────────────────────────────┐
│          Presentation Layer (前端)          │
│  ┌────────┬──────────┬──────────┬─────────┐ │
│  │ Header │ Sidebar  │ MainView │ LogView │ │
│  └────────┴──────────┴──────────┴─────────┘ │
└─────────────────────────────────────────────┘
                     ↕ (IPC Commands)
┌─────────────────────────────────────────────┐
│         Business Logic Layer (Rust)         │
│  ┌──────────────┬────────────┬────────────┐ │
│  │ FileParser   │ RegexEngine│ SessionMgr │ │
│  └──────────────┴────────────┴────────────┘ │
└─────────────────────────────────────────────┘
                     ↕
┌─────────────────────────────────────────────┐
│            Data Layer (磁盘 I/O)            │
│            .log / .txt 文件读取              │
└─────────────────────────────────────────────┘
```

### 3.2 核心模块

#### 3.2.1 前端模块
1. **文件管理器 (FileManager)**
   - 拖拽上传日志文件
   - 支持多文件选择
   - 显示文件基本信息（大小、行数）

2. **配置面板 (ConfigPanel)**
   - Boot 标识符设置（正则表达式）
   - 指标提取规则配置
   - 日志级别过滤器
   - 配置模板保存/加载

3. **会话选择器 (SessionSelector)**
   - 展示所有检测到的 Boot 会话
   - 会话对比模式（多选）
   - 时间线视图

4. **数据看板 (Dashboard)**
   - 关键指标卡片（峰值、均值、变化率）
   - 趋势图表（折线图、柱状图）
   - 异常检测标记

5. **日志查看器 (LogViewer)**
   - 虚拟滚动（支持百万行）
   - 级别染色（ERROR 红色、WARN 橙色等）
   - 关键字高亮
   - 跳转到源文件行号

#### 3.2.2 后端模块
1. **文件解析器 (file_parser.rs)**
   ```rust
   pub struct LogFile {
       path: PathBuf,
       lines: Vec<String>,
       sessions: Vec<Session>,
   }
   
   pub struct Session {
       id: usize,
       start_line: usize,
       end_line: usize,
       boot_marker: String,
   }
   ```

2. **正则引擎 (regex_engine.rs)**
   ```rust
   pub fn extract_metrics(
       lines: &[String],
       pattern: &str,
   ) -> Vec<MetricPoint> {
       // 高性能正则匹配
   }
   ```

3. **会话管理器 (session_manager.rs)**
   ```rust
   pub fn split_by_boot(
       lines: &[String],
       boot_regex: &str,
   ) -> Vec<Session> {
       // 自动切分会话
   }
   ```

---

## 4. 核心功能设计

### 4.1 Boot 会话自动切分
**流程**：
1. 用户上传日志文件
2. 用户输入 Boot 标识符（如 `System Start|initialization|--- Boot ---`）
3. Rust 后端扫描全文，记录所有匹配位置
4. 生成 Session 列表：`[Session#1(0-150行), Session#2(151-300行), ...]`
5. 前端渲染下拉列表供用户切换

**优化**：
- 支持自定义会话命名（读取启动行的版本号等）
- 缓存切分结果，避免重复计算

### 4.2 指标提取与可视化
**支持的指标类型**：
1. **数值型**：内存占用 `mem: (\d+)`
2. **频率型**：错误计数 `ERROR`
3. **时间型**：响应耗时 `latency=(\d+)ms`

**可视化组件**：
- 折线图：展示指标随时间变化
- 柱状图：对比不同 Boot 的峰值
- 散点图：检测异常点

### 4.3 多级日志过滤
**级别检测规则**：
```typescript
const LOG_LEVELS = {
  ERROR: { keywords: ['ERROR', 'FATAL', 'CRITICAL'], color: '#ef4444' },
  WARN:  { keywords: ['WARN', 'WARNING'], color: '#f59e0b' },
  INFO:  { keywords: ['INFO'], color: '#3b82f6' },
  DEBUG: { keywords: ['DEBUG', 'TRACE'], color: '#6b7280' },
};
```

**交互设计**：
- Sidebar 提供 Checkbox 组，快速切换显示级别
- 日志查看器实时刷新

### 4.4 配置模板系统
**模板结构**：
```json
{
  "name": "STM32 内存分析",
  "boot_marker": "System Start",
  "metrics": [
    {
      "name": "Heap Usage",
      "pattern": "heap: (\\d+)",
      "unit": "KB"
    }
  ],
  "log_levels": ["INFO", "WARN", "ERROR"]
}
```

**功能**：
- 保存到本地 JSON 文件
- 导入/导出模板
- 内置常见芯片的预设模板（ESP32、STM32 等）

---

## 5. UI/UX 设计

### 5.1 整体布局
```
┌─────────────────────────────────────────────────────────┐
│  LogView                                    □  ─  ×     │
├───────────┬─────────────────────────────────────────────┤
│           │  [数据看板]  [日志流]  [配置]              │
│ 配置区     │                                             │
│           │   ┌────────┬────────┬────────┐              │
│ 📁 文件   │   │ 峰值   │ 均值   │ 总数   │              │
│ File.log  │   │ 1024MB │ 512MB  │ 1203   │              │
│           │   └────────┴────────┴────────┘              │
│ ⚙️ Boot   │                                             │
│ [v] #1    │   📈 内存趋势图                              │
│ [ ] #2    │   ┌─────────────────────────────────────┐   │
│           │   │         ╱╲                          │   │
│ 🎯 级别    │   │      ╱    ╲      ╱╲                │   │
│ [x] ERROR │   │   ╱         ╲  ╱    ╲              │   │
│ [x] WARN  │   │                        ╲            │   │
│ [x] INFO  │   └─────────────────────────────────────┘   │
│ [ ] DEBUG │                                             │
│           │                                             │
│ 📊 指标    │   🔍 [搜索关键字]                           │
│ + 添加规则│   ┌─────────────────────────────────────┐   │
│           │   │ [ERROR] Memory leak detected!       │   │
│           │   │ [INFO]  mem: 1024                   │   │
│           │   │ [WARN]  Battery low                 │   │
│           │   └─────────────────────────────────────┘   │
└───────────┴─────────────────────────────────────────────┘
```

### 5.2 配色方案
**Dark Mode（默认）**：
- 背景：`#1e1e1e`
- 卡片：`#2d2d2d`
- 文字：`#e0e0e0`
- 强调色：`#3b82f6`（蓝色）

**Light Mode**：
- 背景：`#ffffff`
- 卡片：`#f3f4f6`
- 文字：`#1f2937`

### 5.3 交互细节
1. **文件拖拽上传**：虚线边框，拖入时高亮
2. **日志行悬停**：显示完整日志和行号
3. **图表交互**：点击数据点跳转到对应日志行
4. **快捷键**：`Ctrl+F` 搜索，`Ctrl+O` 打开文件

---

## 6. 数据流设计

### 6.1 文件加载流程
```
用户拖入文件
    ↓
前端调用 Tauri Command: load_file(path)
    ↓
Rust 读取文件到内存
    ↓
返回 { total_lines, file_size, preview }
    ↓
前端显示文件信息
```

### 6.2 会话切分流程
```
用户输入 Boot Marker
    ↓
前端调用: split_sessions(boot_regex)
    ↓
Rust 正则扫描，生成 Session 列表
    ↓
返回 [{ id, start, end, label }]
    ↓
前端渲染 SessionSelector
```

### 6.3 指标提取流程
```
用户配置指标规则
    ↓
前端调用: extract_metrics(session_id, pattern)
    ↓
Rust 在指定 Session 范围内匹配
    ↓
返回 [{ index, value, raw_line }]
    ↓
前端使用 Recharts 绘制图表
```

---

## 7. 性能优化策略

### 7.1 大文件处理
- **流式读取**：使用 `BufReader` 逐行读取，避免一次性加载
- **分页渲染**：日志查看器使用 `react-window`，只渲染可见区域
- **Web Worker**：将正则匹配放到 Worker 线程（如果性能瓶颈在前端）

### 7.2 正则优化
- **预编译**：缓存 `Regex::new()` 的结果
- **并行处理**：使用 `rayon` 并行扫描不同 Session

### 7.3 内存管理
- **延迟加载**：只在切换 Session 时加载对应行
- **LRU 缓存**：缓存最近访问的 Session 数据

---

## 8. 安全性考虑

### 8.1 文件访问
- 使用 Tauri 的 `fs` scope 限制文件访问范围
- 禁止执行文件（只读取 `.log`, `.txt`）

### 8.2 正则注入
- 对用户输入的正则进行校验
- 设置匹配超时（避免正则 DoS）

---

## 9. 实施计划

### Phase 1: 基础框架（1-2 天）
- [x] 设计文档编写
- [ ] Tauri 项目初始化
- [ ] 前端基础布局（Header + Sidebar + Main）
- [ ] Rust 文件读取模块

### Phase 2: 核心功能（3-4 天）
- [ ] Boot 会话切分逻辑
- [ ] 正则指标提取
- [ ] 日志级别检测
- [ ] 前端状态管理（Zustand）

### Phase 3: 可视化（2-3 天）
- [ ] Recharts 集成
- [ ] 数据看板实现
- [ ] 日志查看器（虚拟滚动 + 染色）

### Phase 4: 高级特性（2-3 天）
- [ ] 配置模板系统
- [ ] 多 Session 对比
- [ ] 导出报告（PDF/HTML）

### Phase 5: 优化与打包（1-2 天）
- [ ] 性能测试与优化
- [ ] 打包 Windows/macOS/Linux 版本
- [ ] 编写用户文档

---

## 10. 技术风险与应对

| 风险 | 影响 | 应对方案 |
|------|------|----------|
| 正则性能差 | 大文件卡顿 | 使用 Rust regex + 并行处理 |
| 内存占用高 | 无法处理超大文件 | 流式读取 + 分页渲染 |
| 用户不会写正则 | 上手困难 | 提供可视化正则构建器 |
| 跨平台兼容性 | Linux 字体渲染问题 | 使用 Web 字体 + 充分测试 |

---

## 11. 未来扩展方向

1. **AI 辅助分析**：自动检测内存泄漏模式
2. **远程日志**：支持 SSH 连接设备实时抓取
3. **插件系统**：允许用户自定义解析器
4. **团队协作**：分享配置模板到云端
5. **移动端**：开发 iOS/Android 轻量版

---

## 12. 总结

本设计采用 **Tauri (Rust + React)** 架构，充分发挥 Rust 的性能优势和前端生态的丰富性，打造一款专为嵌入式开发者设计的日志分析工具。通过 Boot 会话切分、多级日志过滤、灵活的正则配置等特性，解决了嵌入式日志分析的核心痛点。

预计开发周期：**10-15 天**  
目标打包体积：**< 10MB**  
支持平台：**Windows, macOS, Linux**
