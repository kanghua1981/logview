# LogView “脱水模式 (Dehydration Mode)” 技术方案文档

## 1. 概念定义
**脱水模式**：一种高效的日志分析视图，旨在屏蔽大量无关的“噪音”日志，仅保留用户关心的关键行（命中高亮关键字的行）及其上下游关系（Context Lines），同时叠加日志级别和会话范围的过滤。

## 2. 核心架构
采用了 **“索引驱动 + 后端并行计算 + 前端分块加载”** 的架构，确保在处理百万级行数日志时依然秒开、不卡顿。

### 2.1 运行生命周期 (Three-Stage Logic)

本方案的执行分为三个明确阶段：

1.  **阶段一：策略下发 (Frontend -> Backend)**
    前端将用户配置的关键字列表、启用的日志级别、选中的会话范围以及上下文行数（Context Lines）封装，通过调用 `get_filtered_indices` 接口发送至 Rust 后端。

2.  **阶段二：并行匹配与索引构建 (Backend)**
    后端利用 `rayon` 并行引擎对全量日志进行多线程扫描：
    - 依次执行：范围过滤 -> 级别匹配 -> 关键字检索。
    - 若配置了上下文行数，则对命中的行进行“范围膨胀”。
    - **输出**：返回一个严格升序、去重后的物理行号映射数组 `number[]`。

3.  **阶段三：视口驱动的内容拉取 (Viewport-Driven Fetching)**
    前端基于返回的索引数组构建虚拟列表：
    - `react-virtuoso` 实时监测当前滚动位置及视口范围。
    - 针对视口内“缺失内容”的离散行号，通过 `get_log_lines_by_indices` 接口发起**按需批量拉取**。
    - 仅加载当前窗口及其前后预缓冲区（Buffer）的日志内容，实现内存和通信的最优解。

---

## 3. 后端逻辑实现 (Rust)
核心逻辑位于 `src-tauri/src/lib.rs` 的 `get_filtered_indices` 函数中。

### 3.1 过滤优先级
后端执行过滤时遵循以下严格顺序：
1. **范围过滤 (Session Range)**：如果选中了特定的会话，只处理该行号范围内的日志。
2. **级别过滤 (Log Level)**：对比每行预提取的级别，若不属于勾选级别则直接剔除。
3. **内容匹配 (Keyword Match)**：
   - 检查该行是否包含高亮关键字。
   - 如果用户未开启“仅显示高亮”，则只要通过级别过滤即保留。
   - **核心逻辑**：一旦开启脱水匹配，未命中关键字的行将被标记为 `false`。

### 3.2 上下文关联 (Context Expansion)
为了保留问题的上下文，系统支持“上下文轮廓”：
- **算法**：在使用 `rayon` 并行扫描后得到一个 `bool` 掩码。
- **扩展**：如果某行命中，则将其前后 `N` 行在掩码中也置为 `true`。
- **去重**：使用顺序收集掩码中为 `true` 的索引，天然保证了索引的升序和唯一性。

---

## 4. 前端逻辑实现 (TypeScript)
核心逻辑位于 `src/store.ts` 和 `src/components/LogViewer.tsx`。

### 4.1 状态驱动
`LogStore` (Zustand) 管理所有过滤因子：
- `logLevelFilter`: 当前显示的级别（如 INFO, ERROR）。
- `selectedSessionIds`: 选中的会话区间。
- `highlights`: 关键字列表及其启用状态。
- `highlightContextLines`: 上下文行数设置。

### 4.2 智能请求 (Chunked Fetching)
在脱水模式下，行号可能是跨度极大的（例如第 10 行之后直接是第 100,000 行）。
- **优化点**：`LogViewer` 不再一次性请求大跨度的行，而是先将可见的离散索引进行分块（Chunking），连续的行一起请求，跨度大的行分多次 IPC 请求。这优化了大量过滤场景下的 IPC 传输性能。

---

## 5. 核心性能优化总结
| 特性 | 实现方式 | 收益 |
| :--- | :--- | :--- |
| **匹配速度** | Rust + `rayon` 多线程并行匹配 | 18万行日志过滤耗时 < 50ms |
| **内存占用** | 内存映射 `MMap` 访问原文件 | 无需将整个大文件读入内存 |
| **传输效率** | 仅通过 IPC 传输 `number[]` 索引 | 避免了万级字符串传输的开销 |
| **渲染性能** | `react-virtuoso` 虚拟列表 | 无论过滤后剩余多少行，DOM 节点始终保持恒定 |

## 6. 常见问答 (FAQ)
*   **Q: 为什么脱水模式里还是能看到没匹配到的行？**
    *   **A**: 请检查是否设置了 `Context Lines`（上下文行数）。如果该行出现在匹配行的前后 `N` 行内，它会被作为背景信息予以保留。
*   **Q: 为什么某些带级别的行也被过滤掉了？**
    *   **A**: 为了保证脱水的“干净”，系统逻辑规定：如果启用了级别过滤器，且某行无法被解析出级别（不符合级别正则），则默认不显示该行。
